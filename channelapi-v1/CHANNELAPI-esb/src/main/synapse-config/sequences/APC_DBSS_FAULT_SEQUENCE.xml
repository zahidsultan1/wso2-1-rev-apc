<?xml version="1.0" encoding="UTF-8"?>
<sequence name="APC_DBSS_FAULT_SEQUENCE" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <switch source="$ctx:Case" xmlns:ns="http://org.apache.synapse/xsd">
        <case regex="TopUpPayment">
            <property name="Status" scope="default" type="STRING" value="F"/>
            <property name="Reason" scope="default" type="STRING" value="Failed"/>
            <filter regex="Refill" source="$ctx:Recon">
                <then>
                    <property name="Status" scope="default" type="STRING" value="R"/>
                    <property name="Reason" scope="default" type="STRING" value="RE-Recon"/>
                </then>
                <else/>
            </filter>
            <filter regex="RBS" source="$ctx:Recon">
                <then>
                    <property name="Status" scope="default" type="STRING" value="R"/>
                    <property name="Reason" scope="default" type="STRING" value="RB-Recon"/>
                </then>
                <else/>
            </filter>
            <filter regex="UpdateBalanceAndDate" source="$ctx:Recon">
                <then>
                    <property name="Status" scope="default" type="STRING" value="R"/>
                    <property name="Reason" scope="default" type="STRING" value="WS-Recon"/>
                </then>
                <else/>
            </filter>
            <filter regex="UpdateBalanceAndDateReversal" source="$ctx:Recon">
                <then>
                    <property name="Status" scope="default" type="STRING" value="R"/>
                    <property name="Reason" scope="default" type="STRING" value="WA-Recon"/>
                </then>
                <else/>
            </filter>
            <property expression="get-property('SYSTEM_TIME')" name="CURR_TIME" scope="default" type="STRING"/>
            <property expression="get-property('SYSTEM_DATE', 'yyyy-MM-dd HH:mm:ss.SSS')" name="SYS_TIME" scope="default" type="STRING"/>
            <property expression="$ctx:InterfaceName" name="INTERFACE_NAME" scope="default" type="STRING"/>
            <dbreport>
                <connection>
                    <pool>
                        <dsName>jdbc/apcrevamp</dsName>
                    </pool>
                </connection>
                <statement>
                    <sql><![CDATA[INSERT INTO `LOG_RESPONSE` (`ID`, `SYSTEM_NAME`, `INTERFACE_NAME`, `TIMEOUT`, `RESPONSE`, `ORDER_ID`, `STATUS`, `MSISDN`) VALUES (?,?,?,?,?,?,?,?)							]]></sql>
                    <parameter expression="$ctx:Transaction_Id" type="VARCHAR"/>
                    <parameter type="VARCHAR" value="WSO2 PAYMENT"/>
                    <parameter expression="$ctx:InterfaceName" type="VARCHAR"/>
                    <parameter expression="$ctx:SYS_TIME" type="VARCHAR"/>
                    <parameter expression="get-property('ERROR_MESSAGE')" type="VARCHAR"/>
                    <parameter expression="$ctx:RECEIPT_NUMBER" type="VARCHAR"/>
                    <parameter expression="$ctx:ERROR_CODE" type="VARCHAR"/>
                    <parameter expression="$ctx:Msisdn" type="VARCHAR"/>
                </statement>
            </dbreport>
            <dbreport>
                <connection>
                    <pool>
                        <dsName>jdbc/apcrevamp</dsName>
                    </pool>
                </connection>
                <statement>
                    <sql><![CDATA[
							INSERT INTO `HUB_TRANSACTION_STATUS` (`ID`, `MSISDN`, `CHANNEL_NAME`, `AMOUNT`, `STATUS`, `RECEIPT_NO`, `DESCRIPTION`) VALUES (?,?,?,?,?,?,?)	
					]]></sql>
                    <parameter expression="$ctx:Transaction_Id" type="VARCHAR"/>
                    <parameter expression="$ctx:Msisdn" type="VARCHAR"/>
                    <parameter expression="$ctx:Channel_Name" type="VARCHAR"/>
                    <parameter expression="$ctx:Amount" type="VARCHAR"/>
                    <parameter expression="$ctx:Reason" type="VARCHAR"/>
                    <parameter expression="$ctx:RECEIPT_NUMBER" type="VARCHAR"/>
                    <parameter expression="$ctx:ERROR_MESSAGE" type="VARCHAR"/>
                </statement>
            </dbreport>
            <payloadFactory media-type="xml">
                <format>
                    <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:tem="http://tempuri.org/">
                        <soapenv:Body>
                            <tem:TopUpPaymentResponse>
                                <tem:TopUpPaymentResult>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;ACTIVITY&gt;&lt;TransactionId&gt;$1&lt;/TransactionId&gt;&lt;MSISDN&gt;$2&lt;/MSISDN&gt;&lt;Status&gt;$3&lt;/Status&gt;&lt;Reason&gt;$4&lt;/Reason&gt;&lt;Message&gt;Your request has failed due to Timeout issue. Please try again later.&lt;/Message&gt;&lt;ReceiptNo/&gt;&lt;/ACTIVITY&gt;</tem:TopUpPaymentResult>
                            </tem:TopUpPaymentResponse>
                        </soapenv:Body>
                    </soapenv:Envelope>
                </format>
                <args>
                    <arg evaluator="xml" expression="$ctx:TransactionId"/>
                    <arg evaluator="xml" expression="$ctx:Msisdn"/>
                    <arg evaluator="xml" expression="$ctx:Status"/>
                    <arg evaluator="xml" expression="$ctx:Reason"/>
                </args>
            </payloadFactory>
            <property name="HTTP_SC" scope="axis2" type="STRING" value="500"/>
            <property name="messageType" scope="axis2" type="STRING" value="text/xml"/>
            <property action="remove" name="NO_ENTITY_BODY" scope="axis2"/>
            <property name="RESPONSE" scope="default" type="STRING" value="true"/>
            <header action="remove" name="To" scope="default"/>
            <respond/>
        </case>
        <default/>
    </switch>
</sequence>
