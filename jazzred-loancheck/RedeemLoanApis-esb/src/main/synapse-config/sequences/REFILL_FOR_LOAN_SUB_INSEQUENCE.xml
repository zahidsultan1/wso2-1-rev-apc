<?xml version="1.0" encoding="UTF-8"?>
<sequence name="REFILL_FOR_LOAN_SUB_INSEQUENCE" xmlns="http://ws.apache.org/ns/synapse">
	<log level="custom">
		<property name="REFILL" value="INSIDE"/>
	</log>
	<property name="REFILL_CHECK" scope="default" type="STRING" value="0"/>
	<property expression="get-property('SYSTEM_TIME')" name="CURR_TIME" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>
	<property expression="fn:concat(synapse:get-property('SYSTEM_DATE', 'yyyyMMdd'),'T',synapse:get-property('SYSTEM_DATE', 'HH:mm:ss+0500'))" name="CURR_DATE_TIME" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>
	<payloadFactory media-type="xml">
		<format>
			<methodCall xmlns="">
				<methodName>Refill</methodName>
				<params>
					<param>
						<value>
							<struct>
								<member>
									<name>originNodeType</name>
									<value>
										<string>EXT</string>
									</value>
								</member>
								<member>
									<name>originHostName</name>
									<value>
										<string>WSO2</string>
									</value>
								</member>
								<member>
									<name>originTransactionID</name>
									<value>
										<string>$2</string>
									</value>
								</member>
								<member>
									<name>originTimeStamp</name>
									<value>
										<dateTime.iso8601>$1</dateTime.iso8601>
									</value>
								</member>
								<member>
									<name>subscriberNumber</name>
									<value>
										<string>$4</string>
									</value>
								</member>
								<member>
									<name>transactionCurrency</name>
									<value>
										<string>PKR</string>
									</value>
								</member>
								<member>
									<name>transactionAmount</name>
									<value>
										<string>$3</string>
									</value>
								</member>
								<member>
									<name>transactionType</name>
									<value>
										<string>WSO2</string>
									</value>
								</member>
								<member>
									<name>transactionCode</name>
									<value>
										<string>WSO2TOPUP</string>
									</value>
								</member>
								<member>
									<name>refillProfileID</name>
									<value>
										<string>$7</string>
									</value>
								</member>
								<member>
									<name>externalData1</name>
									<value>
										<string>$5</string>
									</value>
								</member>
								<member>
									<name>externalData2</name>
									<value>
										<string>VOMS_Recharge</string>
									</value>
								</member>
							</struct>
						</value>
					</param>
				</params>
			</methodCall>
		</format>
		<args>
			<arg evaluator="xml" expression="$ctx:CURR_DATE_TIME" literal="false" xmlns:ns="http://org.apache.synapse/xsd"/>
			<arg evaluator="xml" expression="$ctx:TRANSACTION_ID" literal="false" xmlns:ns="http://org.apache.synapse/xsd"/>
			<arg evaluator="xml" expression="$ctx:Amount_Paisa" literal="false" xmlns:ns="http://org.apache.synapse/xsd"/>
			<arg evaluator="xml" expression="$ctx:NORMALIZED_MSISDN_FOR_IN" literal="false" xmlns:ns="http://org.apache.synapse/xsd"/>
			<arg evaluator="xml" expression="$ctx:HostName" literal="false" xmlns:ns="http://org.apache.synapse/xsd"/>
			<arg evaluator="xml" expression="$ctx:TRANSACTION_ID" literal="false" xmlns:ns="http://org.apache.synapse/xsd"/>
			<arg evaluator="xml" expression="$ctx:REFILL_ID" literal="false" xmlns:ns="http://org.apache.synapse/xsd"/>
		</args>
	</payloadFactory>
	<property name="INTERFACE_NAME" value="LOAN_SUB_REFILL"/>
	<property name="RESOURCE_URI" scope="default" type="STRING" value="http://10.13.32.180:10010/Air"/>
	<sequence key="LOYALTY_MSA_LOG_REQUEST"/>
	<property name="DISABLE_CHUNKING" scope="axis2" value="true"/>
	<property action="remove" name="HTTP_SC" scope="transport"/>
	<property name="FORCE_HTTP_1.0" value="true"/>
	<property name="FORCE_HTTP_1.1" scope="axis2" value="true"/>
	<property name="messageType" value="application/xml"/>
	<property name="ContentType" scope="axis2" type="STRING" value="text/xml"/>
	<property action="remove" name="Content-Encoding" scope="transport"/>
	<property action="remove" name="Content-Length" scope="transport"/>
	<property action="remove" name="Accept-Encoding"/>
	<!-- <header name="User-Agent" scope="transport" value="UGw Server/5.0/1.0"/> -->
	<!-- <header name="Authorization" scope="transport" value="Basic ZmRzdXNlcjpmZHN1c2Vy="/> -->
	<header name="User-Agent" scope="transport" value="UGw Server/4.3/1.0"/>
	<header name="Authorization" scope="transport" value="Basic SU5UQVJDQU5BOjU2djM0R3oxL0FfMTgK"/>
	<call>
		<endpoint key="APC_AIR_EP"/>
	</call>
	<property name="IsClientDoingREST" scope="default" type="BOOLEAN" value="true"/>
	<property name="ContentType" scope="axis2" type="STRING" value="text/xml"/>
	<enrich>
		<source clone="true" type="body"/>
		<target action="replace" property="IN_PAYLOAD" type="property"/>
	</enrich>
	<property expression="//methodResponse/params/param/value/struct/member[name='responseCode']/value/i4/text()']" name="Responsecode" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>
	<property expression="//methodResponse/fault/value/struct/member[name='faultCode']/value/i4/text()" name="faultCode" xmlns:ns="http://org.apache.synapse/xsd"/>
	<property expression="//methodResponse/fault/value/struct/member[name='faultString']/value/i4/text()" name="faultDescription" xmlns:ns="http://org.apache.synapse/xsd"/>
	<log level="custom">
		<property expression="//methodResponse/params/param/value/struct/member[name='responseCode']/value/i4/text()']" name="Responsecode" xmlns:ns="http://org.apache.synapse/xsd"/>
	</log>
	<property name="STATUS" scope="default" type="STRING" value="OK"/>
	<property expression="fn:concat('ResponseCode:',$ctx:Responsecode)" name="RESPONSE" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>
	<sequence key="LOYALTY_MSA_LOG_RESPONSE"/>
	<property expression="$axis2:HTTP_SC" name="StatusCode" xmlns:ns="http://org.apache.synapse/xsd"/>
	<filter xmlns:ns="http://org.apache.synapse/xsd" xpath="$ctx:Responsecode !=0">
		<then>
			<property name="REFILL_CHECK" scope="default" type="STRING" value="1"/>
			<property expression="$ctx:Responsecode" name="Responsecode"/>
		</then>
	</filter>
</sequence>
